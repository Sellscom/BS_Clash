<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
    const tg = window.Telegram.WebApp;
    // ЗАМЕНИТЕ ЭТУ ССЫЛКУ на адрес вашего запущенного сервера
    const socket = io("https://bs-clash.onrender.com"); 

    let currentRoom = null;
    let myRole = null; // 'first' или 'second'
    let isMultiplayer = false;

    // --- Сетевые события ---

    function startMultiplayer() {
        isMultiplayer = true;
        showScreen('searching');
        
        // Отправляем данные игрока серверу
        socket.emit('find_game', {
            name: tg.initDataUnsafe.user?.first_name || "Игрок",
            id: tg.initDataUnsafe.user?.id
        });
    }

    socket.on('game_start', (data) => {
        currentRoom = data.room;
        myRole = data.role;
        isPlayerTurn = (myRole === 'first');
        
        tg.HapticFeedback.notificationOccurred('success');
        setupGame(); // Расставляем свои корабли
        showScreen('game');
        
        statusEl.innerText = isPlayerTurn ? "Ваш ход (против " + data.opponent.name + ")" : "Ход противника (" + data.opponent.name + ")";
    });

    // Обработка клика по чужому полю (выстрел)
    function shoot(idx) {
        if (!isPlayerTurn || enemyBoard[idx] > 0) return;

        if (isMultiplayer) {
            // В мультиплеере мы просто ждем ответа от врага
            socket.emit('shot', { room: currentRoom, index: idx });
            isPlayerTurn = false; // Блокируем до ответа
        } else {
            // Логика для бота (старая)
        }
    }

    // Враг прислал результат нашего выстрела
    socket.on('enemy_shot_result', (data) => {
        enemyBoard[data.index] = data.status;
        if (data.status === 3) {
            isPlayerTurn = true; // Попали — ходим снова
            playSound('hit');
        } else {
            playSound('miss');
        }
        render();
    });

    // Враг выстрелил в нас
    socket.on('enemy_shot', (data) => {
        const cellValue = pBoard[data.index];
        const resultStatus = cellValue === 1 ? 3 : 2; // 3 - попал, 2 - мимо
        
        pBoard[data.index] = resultStatus;
        
        // Отправляем врагу результат нашего повреждения
        socket.emit('shot_result', { 
            room: currentRoom, 
            index: data.index, 
            status: resultStatus 
        });

        if (resultStatus === 2) {
            isPlayerTurn = true; // Враг промазал — наш ход
        } else {
            tg.HapticFeedback.impactOccurred('heavy');
        }
        render();
    });
</script>