<script>
    // 1. Инициализация Telegram SDK с защитой
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
        tg.ready();
        tg.expand();
    }

    // 2. Настройка подключения к серверу (с защитой от зависания)
    // ОБЯЗАТЕЛЬНО ЗАМЕНИТЕ НА ВАШ URL ИЗ RENDER
    const SERVER_URL = "https://bs-clash.onrender.com"; 
    
    let socket;
    try {
        socket = io(SERVER_URL, { 
            transports: ["websocket", "polling"],
            timeout: 5000,
            reconnectionAttempts: 3
        });
    } catch (e) {
        console.error("Ошибка подключения к серверу:", e);
    }

    // Состояния игры
    let mode = 'pve'; 
    let pBoard = Array(100).fill(0);
    let eBoard = Array(100).fill(0);
    let shipsToPlace = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
    let isVert = false;
    let isPlayerTurn = true;
    let currentRoom = null;

    // --- Функция переключения экранов (теперь работает всегда) ---
    function showScreen(id) {
        const screens = ['screen-menu', 'screen-loading', 'screen-setup', 'screen-game'];
        screens.forEach(s => {
            const el = document.getElementById(s);
            if (el) el.style.display = (s === id) ? 'flex' : 'none';
        });
    }

    // --- Логика кнопок меню ---
    function startSetup(m) {
        mode = m;
        pBoard.fill(0);
        shipsToPlace = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
        showScreen('screen-setup');
        renderSetup();
    }

    // Отрисовка расстановки
    function renderSetup() {
        const b = document.getElementById('pb-setup');
        if (!b) return;
        b.innerHTML = '';
        
        const title = document.getElementById('setup-title');
        if (title) title.innerText = `Корабль: ${shipsToPlace[0]} кл.`;

        pBoard.forEach((v, i) => {
            const c = document.createElement('div');
            c.className = 'cell' + (v === 1 ? ' ship' : '');
            // Используем onclick и touchstart для лучшего отклика в TG
            c.onclick = (e) => {
                e.preventDefault();
                placeShip(i);
            };
            b.appendChild(c);
        });
    }

    function placeShip(idx) {
        const len = shipsToPlace[0];
        if (canPlace(pBoard, idx, len, isVert)) {
            for (let i = 0; i < len; i++) {
                pBoard[isVert ? idx + i * 10 : idx + i] = 1;
            }
            shipsToPlace.shift();
            if (shipsToPlace.length === 0) {
                if (mode === 'pvp') {
                    startMultiplayerSearch();
                } else {
                    showScreen('screen-game');
                    renderGame();
                }
            } else {
                renderSetup();
            }
        }
    }

    // Мультиплеер
    function startMultiplayerSearch() {
        showScreen('screen-loading');
        if (!socket || !socket.connected) {
            alert("Сервер недоступен. Попробуйте режим с ботом или подождите 30 сек.");
            showScreen('screen-menu');
            return;
        }
        socket.emit('find_game', { 
            name: tg?.initDataUnsafe?.user?.first_name || "Игрок" 
        });
    }

    // Обработка событий сети
    if (socket) {
        socket.on('game_start', (data) => {
            currentRoom = data.room;
            isPlayerTurn = (data.role === 'first');
            eBoard.fill(0);
            showScreen('screen-game');
            renderGame();
        });

        socket.on('enemy_shot', (data) => {
            const res = pBoard[data.index] === 1 ? 3 : 2;
            pBoard[data.index] = res;
            socket.emit('shot_result', { room: currentRoom, index: data.index, status: res });
            isPlayerTurn = (res === 2);
            renderGame();
        });

        socket.on('enemy_shot_result', (data) => {
            eBoard[data.index] = data.status;
            isPlayerTurn = (data.status === 3);
            renderGame();
        });
    }

    // Вспомогательные функции (canPlace, renderGame и т.д. остаются прежними)
    function canPlace(board, start, len, vert) {
        const x = start % 10, y = Math.floor(start / 10);
        for (let i = 0; i < len; i++) {
            const cx = vert ? x : x + i, cy = vert ? y + i : y;
            if (cx >= 10 || cy >= 10) return false;
            for (let dy = -1; dy <= 1; dy++) {
                for (let dx = -1; dx <= 1; dx++) {
                    const nx = cx + dx, ny = cy + dy;
                    if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10 && board[ny * 10 + nx] === 1) return false;
                }
            }
        }
        return true;
    }

    function renderGame() {
        const eb = document.getElementById('eb');
        const pb = document.getElementById('pb');
        if (!eb || !pb) return;

        eb.innerHTML = '';
        eBoard.forEach((v, i) => {
            const c = document.createElement('div');
            c.className = 'cell' + (v === 2 ? ' miss' : v === 3 ? ' hit' : '');
            c.onclick = () => { if(isPlayerTurn) playerShoot(i); };
            eb.appendChild(c);
        });

        pb.innerHTML = '';
        pBoard.forEach((v, i) => {
            const c = document.createElement('div');
            c.className = 'cell' + (v === 1 ? ' ship' : v === 2 ? ' miss' : v === 3 ? ' hit' : '');
            pb.appendChild(c);
        });

        const st = document.getElementById('game-status');
        st.innerText = isPlayerTurn ? "ВАШ ХОД" : "ХОД ВРАГА";
    }

    function playerShoot(idx) {
        if (!isPlayerTurn || eBoard[idx] > 0) return;
        if (mode === 'pvp') {
            socket.emit('shot', { room: currentRoom, index: idx });
            isPlayerTurn = false;
        } else {
            // Упрощенный бот для теста
            eBoard[idx] = Math.random() > 0.8 ? 3 : 2;
            if (eBoard[idx] === 2) {
                isPlayerTurn = false;
                setTimeout(() => { isPlayerTurn = true; renderGame(); }, 1000);
            }
        }
        renderGame();
    }
</script>
