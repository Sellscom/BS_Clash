<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sea Battle: Full Navigation</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; margin: 0; padding: 10px; text-align: center; color: #2c3e50; user-select: none; overflow-x: hidden; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; min-height: 90vh; }
        .active { display: flex; }
        
        .board { 
            display: grid; grid-template-columns: repeat(10, 1fr); 
            width: min(88vw, 340px); height: min(88vw, 340px); 
            background: #fff; border: 2px solid #2c3e50; margin: 10px auto; 
        }
        .cell { border: 1px solid #e1e8ed; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; }
        .ship { background: #3498db !important; border: 1px solid #2980b9; }
        .hit { background: #e74c3c !important; position: relative; }
        .hit::after { content: "√ó"; color: white; font-size: 20px; font-weight: bold; }
        .miss::after { content: "‚Ä¢"; color: #bdc3c7; font-size: 24px; }

        .btn {
            display: block; width: 100%; max-width: 280px; padding: 15px; margin: 8px auto;
            border-radius: 12px; border: none; background: #3498db; color: white;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .btn-green { background: #2ecc71; }
        .btn-orange { background: #f39c12; }
        .btn-exit { background: #95a5a6; padding: 10px; font-size: 14px; margin-top: 20px; }
        
        #status { font-weight: bold; margin: 10px; color: #2980b9; height: 24px; }
        .player-label { font-size: 14px; font-weight: bold; margin: 5px 0; color: #34495e; }
        
        .result-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px; }
        #online-tag { background: #2ecc71; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        #music-toggle { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid #ccc; z-index: 100; }
    </style>
</head>
<body>

    <div id="music-toggle" onclick="toggleMusic()">üîá</div>

    <div id="sc-menu" class="screen active">
        <h1 style="margin-top: 50px;">–ú–û–†–°–ö–û–ô –ë–û–ô</h1>
        <p>–í —Å–µ—Ç–∏ <span id="online-tag"><span id="online-count">0</span> —á–µ–ª.</span></p>
        <button class="btn" onclick="initAudioAndStart('pve')">–ò–ì–†–ê–¢–¨ –° –ë–û–¢–û–ú</button>
        <button class="btn btn-green" onclick="initAudioAndStart('pvp')">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</button>
    </div>

    <div id="sc-setup" class="screen">
        <h3>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–ª–æ—Ç–∞</h3>
        <p id="setup-info">–°—Ç–∞–≤–∏–º –∫–æ—Ä–∞–±–ª—å...</p>
        <div id="setup-board" class="board"></div>
        <div style="display:flex; gap:10px; width:100%; max-width:340px">
            <button class="btn" onclick="isVertical = !isVertical; this.innerText = isVertical ? '–í–µ—Ä—Ç–∏–∫.' : '–ì–æ—Ä–∏–∑–æ–Ω—Ç.'" style="font-size:12px; padding:10px;">–ì–æ—Ä–∏–∑–æ–Ω—Ç.</button>
            <button class="btn btn-orange" onclick="autoPlace('player')" style="font-size:12px; padding:10px;">–°–ª—É—á–∞–π–Ω–æ</button>
        </div>
        <button class="btn btn-green" id="start-battle-btn" onclick="startBattle()" disabled>–í –ë–û–ô!</button>
        <button class="btn btn-exit" onclick="location.reload()">‚Üê –í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
    </div>

    <div id="sc-game" class="screen">
        <div id="status">–í–ê–® –•–û–î</div>
        <div class="player-label">–í–†–ê–ì: <span id="enemy-name">–ë–æ—Ç</span></div>
        <div id="eb" class="board"></div>
        <div class="player-label">–í–´: <span id="my-name">–ò–≥—Ä–æ–∫</span></div>
        <div id="pb" class="board"></div>
        <button class="btn btn-exit" onclick="confirmExit()">üè≥Ô∏è –ü–û–ö–ò–ù–£–¢–¨ –ë–û–ô</button>
    </div>

    <div id="sc-result" class="screen">
        <div class="result-card">
            <h2 id="result-title">–†–ï–ó–£–õ–¨–¢–ê–¢</h2>
            <p id="result-desc"></p>
            <button class="btn btn-green" onclick="location.reload()">–†–ï–í–ê–ù–®</button>
            <button class="btn btn-exit" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
        </div>
    </div>

<script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const socket = io("https://bs-clash.onrender.com", { transports: ['websocket', 'polling'] });
    
    let audioCtx, isMusicPlaying = false;
    let mode = 'pve', pBoard = Array(100).fill(0), eBoard = Array(100).fill(0), botShips = Array(100).fill(0);
    let isTurn = false, isVertical = false, roomID = null;
    const shipSchema = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
    let currentShipIdx = 0;

    function initAudioAndStart(m) {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            startMusic();
        }
        openSetup(m);
        soundClick();
    }

    function soundClick() { playTone(600, 0.05, 'sine'); }
    function soundHit() { playTone(150, 0.4, 'square'); if(tg) tg.HapticFeedback.impactOccurred('heavy'); }
    function soundMiss() { playTone(300, 0.2, 'sine'); }

    function playTone(freq, dur, type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function startMusic() {
        if (isMusicPlaying) return;
        const melody = [261, 329, 392, 523, 392, 329];
        let noteIdx = 0;
        setInterval(() => {
            if (isMusicPlaying) {
                playTone(melody[noteIdx % melody.length] / 2, 0.8, 'sine');
                noteIdx++;
            }
        }, 1000);
        isMusicPlaying = true;
        document.getElementById('music-toggle').innerText = 'üîä';
    }

    function toggleMusic() {
        isMusicPlaying = !isMusicPlaying;
        document.getElementById('music-toggle').innerText = isMusicPlaying ? 'üîä' : 'üîá';
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function confirmExit() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –±–æ–π? –≠—Ç–æ –±—É–¥–µ—Ç –∑–∞—Å—á–∏—Ç–∞–Ω–æ –∫–∞–∫ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ.")) {
            location.reload();
        }
    }

    function openSetup(m) {
        mode = m; pBoard.fill(0); currentShipIdx = 0;
        showScreen('sc-setup'); renderSetup();
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function renderSetup() {
        const b = document.getElementById('setup-board'); b.innerHTML = '';
        const len = shipSchema[currentShipIdx];
        document.getElementById('setup-info').innerText = len ? `–ü–æ—Å—Ç–∞–≤—å—Ç–µ ${len}-–ø–∞–ª—É–±–Ω—ã–π –∫–æ—Ä–∞–±–ª—å` : "–§–ª–æ—Ç –≥–æ—Ç–æ–≤!";
        for(let i=0; i<100; i++) {
            const c = document.createElement('div');
            c.className = 'cell' + (pBoard[i] === 1 ? ' ship' : '');
            c.onclick = () => { if(len) handlePlace(i, len); };
            b.appendChild(c);
        }
    }

    function handlePlace(idx, len) {
        if(canPlace(idx, len, isVertical, pBoard)) {
            for(let i=0; i<len; i++) pBoard[isVertical ? idx + i*10 : idx + i] = 1;
            currentShipIdx++; soundClick();
            if(currentShipIdx >= shipSchema.length) document.getElementById('start-battle-btn').disabled = false;
            renderSetup();
        }
    }

    function canPlace(idx, len, vert, board) {
        const x = idx % 10, y = Math.floor(idx / 10);
        for (let i = 0; i < len; i++) {
            const cx = vert ? x : x + i, cy = vert ? y + i : y;
            if (cx > 9 || cy > 9) return false;
            for (let v = -1; v <= 1; v++) {
                for (let h = -1; h <= 1; h++) {
                    const nx = cx + h, ny = cy + v;
                    if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) {
                        if (board[ny * 10 + nx] === 1) return false;
                    }
                }
            }
        }
        return true;
    }

    function autoPlace(target) {
        const board = target === 'player' ? pBoard : botShips;
        board.fill(0);
        shipSchema.forEach(len => {
            let placed = false;
            while(!placed) {
                let idx = Math.floor(Math.random()*100), vert = Math.random() > 0.5;
                if(canPlace(idx, len, vert, board)) {
                    for(let i=0; i<len; i++) board[vert ? idx+i*10 : idx+i] = 1;
                    placed = true;
                }
            }
        });
        if(target === 'player') { currentShipIdx = shipSchema.length; document.getElementById('start-battle-btn').disabled = false; renderSetup(); soundClick(); }
    }

    function startBattle() {
        if(mode === 'pvp') {
            socket.emit('find_game', { name: tg?.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫" });
            document.getElementById('status').innerText = "–ü–û–ò–°–ö –í–†–ê–ì–ê...";
        } else {
            autoPlace('bot'); isTurn = true; document.getElementById('status').innerText = "–í–ê–® –•–û–î";
        }
        showScreen('sc-game'); renderGame();
    }

    function handleShot(idx) {
        if(!isTurn || eBoard[idx] > 0) return;
        if(mode === 'pve') {
            const hit = botShips[idx] === 1;
            eBoard[idx] = hit ? 3 : 2; botShips[idx] = hit ? 3 : 2;
            hit ? soundHit() : soundMiss();
            if(!hit) { isTurn = false; setTimeout(botMove, 700); }
            checkWin(); renderGame();
        } else {
            socket.emit('shot', { room: roomID, index: idx }); isTurn = false; renderGame();
        }
    }

    function botMove() {
        let idx; do { idx = Math.floor(Math.random()*100); } while(pBoard[idx] > 1);
        const hit = pBoard[idx] === 1;
        pBoard[idx] = hit ? 3 : 2;
        hit ? soundHit() : soundMiss();
        if(hit) setTimeout(botMove, 700); else isTurn = true;
        checkWin(); renderGame();
    }

    function renderGame() {
        const eb = document.getElementById('eb'), pb = document.getElementById('pb');
        eb.innerHTML = ''; pb.innerHTML = '';
        eBoard.forEach((v, i) => {
            const c = document.createElement('div'); c.className = 'cell' + (v===2?' miss':v===3?' hit':'');
            c.onclick = () => handleShot(i); eb.appendChild(c);
        });
        pBoard.forEach((v, i) => {
            const c = document.createElement('div'); c.className = 'cell' + (v===1?' ship':v===2?' miss':v===3?' hit':'');
            pb.appendChild(c);
        });
    }

    function checkWin() {
        const myLeft = pBoard.filter(v => v === 1).length;
        const botLeft = botShips.filter(v => v === 1).length;
        if(myLeft === 0) showFinal(false);
        else if(mode === 'pve' && botLeft === 0) showFinal(true);
    }

    function showFinal(win) {
        showScreen('sc-result');
        document.getElementById('result-title').innerText = win ? "–ü–û–ë–ï–î–ê!" : "–ü–û–†–ê–ñ–ï–ù–ò–ï!";
        document.getElementById('result-desc').innerText = win ? "–í—Ä–∞–∂–µ—Å–∫–∏–π —Ñ–ª–æ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω!" : "–í–∞—à —Ñ–ª–æ—Ç –ø–æ—Ç–æ–ø–ª–µ–Ω.";
    }

    socket.on('player_count', (c) => document.getElementById('online-count').innerText = c);
    socket.on('game_start', (d) => {
        roomID = d.room; isTurn = (d.role === 'first');
        document.getElementById('enemy-name').innerText = d.opponentName;
        document.getElementById('status').innerText = isTurn ? "–í–ê–® –•–û–î" : "–•–û–î –í–†–ê–ì–ê";
        renderGame();
    });
    socket.on('enemy_shot', (d) => {
        const r = pBoard[d.index] === 1 ? 3 : 2; pBoard[d.index] = r;
        r === 3 ? soundHit() : soundMiss();
        socket.emit('shot_result', { room: roomID, index: d.index, status: r });
        isTurn = (r === 2); renderGame(); checkWin();
    });
    socket.on('enemy_shot_result', (d) => {
        eBoard[d.index] = d.status; d.status === 3 ? soundHit() : soundMiss();
        isTurn = (d.status === 3); renderGame();
        if(eBoard.filter(v => v === 3).length === 20) showFinal(true);
    });
</script>
</body>
</html>
