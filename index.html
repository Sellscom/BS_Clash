<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sea Battle Clash PvP</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: #f0f4f8; margin: 0; padding: 15px; 
            text-align: center; color: #2c3e50; overflow-x: hidden;
        }
        
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .active { display: flex; }

        .board { 
            display: grid; grid-template-columns: repeat(10, 1fr); 
            width: min(88vw, 320px); height: min(88vw, 320px); 
            background: white; border: 2px solid #2c3e50; margin: 10px auto; 
            touch-action: none;
        }
        .cell { border: 1px solid #eee; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 18px; position: relative; }
        
        /* Состояния клеток */
        .ship { background: #3498db; }
        .hit { background: #e74c3c !important; color: white; }
        .hit::after { content: "×"; font-weight: bold; }
        .miss { background: #dcdde1; }
        .miss::after { content: "•"; color: #7f8c8d; font-size: 24px; }

        .btn {
            display: block; width: 100%; max-width: 280px; padding: 18px; margin: 10px auto;
            border-radius: 15px; border: none; background: #3498db; color: white;
            font-weight: bold; font-size: 18px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        #status { font-weight: bold; margin: 15px; color: #2980b9; min-height: 24px; font-size: 18px; }
        .info-text { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        
        #debug-log { font-size: 10px; color: #e74c3c; margin-top: 20px; text-align: left; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="sc-menu" class="screen active">
        <h1 style="margin-top: 40px; letter-spacing: 2px;">МОРСКОЙ БОЙ</h1>
        <button class="btn" onclick="startGame('pve')">ИГРАТЬ С БОТОМ</button>
        <button class="btn" style="background:#2ecc71" onclick="startGame('pvp')">МУЛЬТИПЛЕЕР</button>
        <div id="connection-status" class="info-text">Проверка сервера...</div>
    </div>

    <div id="sc-game" class="screen">
        <div id="status">ПОДГОТОВКА...</div>
        <div id="eb" class="board"></div>
        <div style="margin: 5px 0; font-size: 14px; font-weight: bold; opacity: 0.6;">ВАШ ФЛОТ</div>
        <div id="pb" class="board"></div>
        <button class="btn" style="background:#95a5a6; padding: 12px; font-size: 14px;" onclick="location.reload()">В МЕНЮ</button>
    </div>

    <div id="debug-log"></div>

<script>
    // 1. Настройка Telegram
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
        tg.ready();
        tg.expand();
    }

    // 2. Настройка Сервера
    const SERVER_URL = "https://bs-clash.onrender.com";
    let socket;
    
    // Состояние игры
    let mode = 'pve';
    let pBoard = Array(100).fill(0); // 0-пусто, 1-корабль, 2-мимо, 3-попал
    let eBoard = Array(100).fill(0); 
    let isTurn = false;
    let roomID = null;

    // Инициализация сокета
    try {
        socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
        
        socket.on('connect', () => {
            document.getElementById('connection-status').innerText = "Сервер онлайн ✅";
            document.getElementById('connection-status').style.color = "#2ecc71";
        });

        socket.on('connect_error', () => {
            document.getElementById('connection-status').innerText = "Сервер спит... (ждите 15-30 сек)";
            document.getElementById('connection-status').style.color = "#e67e22";
        });
    } catch(e) {
        document.getElementById('debug-log').innerText = "Ошибка сокета: " + e.message;
    }

    // --- ЛОГИКА ИГРЫ ---

    function startGame(m) {
        // Вибрация при нажатии
        if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

        mode = m;
        
        if (mode === 'pvp' && (!socket || !socket.connected)) {
            alert("Сервер еще не проснулся. Пожалуйста, подождите немного.");
            return;
        }

        // Авто-расстановка (10 случайных клеток)
        pBoard.fill(0);
        let placed = 0;
        while(placed < 10) {
            let i = Math.floor(Math.random() * 100);
            if(pBoard[i] === 0) { pBoard[i] = 1; placed++; }
        }

        if (mode === 'pvp') {
            socket.emit('find_game', { name: tg?.initDataUnsafe?.user?.first_name || "Игрок" });
            document.getElementById('status').innerText = "ПОИСК ПРОТИВНИКА...";
        } else {
            isTurn = true;
            document.getElementById('status').innerText = "ВАШ ХОД";
        }

        showScreen('sc-game');
        render();
    }

    function showScreen(id) {
        document.getElementById('sc-menu').style.display = 'none';
        document.getElementById('sc-game').style.display = 'none';
        document.getElementById(id).style.display = 'flex';
    }

    function render() {
        const eb = document.getElementById('eb');
        const pb = document.getElementById('pb');
        eb.innerHTML = ''; pb.innerHTML = '';

        // Отрисовка поля врага
        eBoard.forEach((v, i) => {
            const c = document.createElement('div');
            c.className = 'cell' + (v === 2 ? ' miss' : v === 3 ? ' hit' : '');
            c.onclick = () => handleShot(i);
            eb.appendChild(c);
        });

        // Отрисовка вашего поля
        pBoard.forEach((v, i) => {
            const c = document.createElement('div');
            c.className = 'cell' + (v === 1 ? ' ship' : v === 2 ? ' miss' : v === 3 ? ' hit' : '');
            pb.appendChild(c);
        });
    }

    function handleShot(idx) {
        if (!isTurn || eBoard[idx] > 0) return;

        if (mode === 'pvp') {
            socket.emit('shot', { room: roomID, index: idx });
            isTurn = false;
            document.getElementById('status').innerText = "ОЖИДАНИЕ...";
        } else {
            // Режим бота
            let hit = Math.random() > 0.8; 
            eBoard[idx] = hit ? 3 : 2;
            if (!hit) {
                isTurn = false;
                document.getElementById('status').innerText = "ХОД БОТА";
                setTimeout(botAttack, 1000);
            }
        }
        render();
    }

    function botAttack() {
        let idx;
        do { idx = Math.floor(Math.random() * 100); } while (pBoard[idx] > 1);
        
        if (pBoard[idx] === 1) {
            pBoard[idx] = 3;
            if (tg) tg.HapticFeedback.impactOccurred('medium');
            setTimeout(botAttack, 800);
        } else {
            pBoard[idx] = 2;
            isTurn = true;
            document.getElementById('status').innerText = "ВАШ ХОД";
        }
        render();
    }

    // --- СОБЫТИЯ МУЛЬТИПЛЕЕРА ---
    if (socket) {
        socket.on('game_start', (data) => {
            roomID = data.room;
            isTurn = (data.role === 'first');
            document.getElementById('status').innerText = isTurn ? "ВАШ ХОД" : "ХОД ПРОТИВНИКА";
            if (tg) tg.HapticFeedback.notificationOccurred('success');
            render();
        });

        socket.on('enemy_shot', (data) => {
            const result = pBoard[data.index] === 1 ? 3 : 2;
            pBoard[data.index] = result;
            
            // Отправляем результат врагу
            socket.emit('shot_result', { room: roomID, index: data.index, status: result });
            
            isTurn = (result === 2); // Если враг промахнулся, наш ход
            document.getElementById('status').innerText = isTurn ? "ВАШ ХОД" : "ХОД ПРОТИВНИКА";
            
            if (result === 3 && tg) tg.HapticFeedback.impactOccurred('heavy');
            render();
        });

        socket.on('enemy_shot_result', (data) => {
            eBoard[data.index] = data.status;
            isTurn = (data.status === 3); // Если попали, ходим снова
            document.getElementById('status').innerText = isTurn ? "ПОПАДАНИЕ! ВАШ ХОД" : "ХОД ПРОТИВНИКА";
            render();
        });
    }

</script>
</body>
</html>
